import { logger } from "hono/logger";
import { configureOpenAPI, createRouter } from "./lib/utils";
import routes from "./routes";
{{#if web}}
import { trpcServer } from "@hono/trpc-server";
import { trpcRouter } from "./trpc/index";
{{/if}}
{{#if database}}import { db } from "./db";{{/if}}
{{#if auth}}import { auth } from "@server/lib/auth";{{/if}}

// Hono App
const app = createRouter().basePath("/api");

// OpenAPI
configureOpenAPI(app);

// Logger
app.use(logger());

// CORS
app.use(
	"*",
	cors({
		origin: process.env.CORS_ORIGIN || "",
		allowHeaders: ["Content-Type", "Authorization"],
		allowMethods: ["POST", "GET", "OPTIONS"],
		exposeHeaders: ["Content-Length"],
		maxAge: 600,
		credentials: true,
	}),
);

{{#if database}}
// DB
app.use("*", (c, next) => {
	c.set("db", db);
	return next();
});
{{/if}}

{{#if auth}}
// Auth
app.use("*", async (c, next) => {
	const session = await auth.api.getSession({ headers: c.req.raw.headers });

	if (!session) {
		c.set("session", null);
		return next();
	}

	c.set("session", session);

	return next();
});

app.on(["POST", "GET"], "/auth/**", (c) => auth.handler(c.req.raw));
{{/if}}

{{#if web}}
// TRPC
app.use(
	"/trpc/*",
	trpcServer({
		endpoint: "/api/trpc",
		router: trpcRouter,
		{{#if (or auth database)}}
    createContext: async (_opts, c) => ({
			{{#if auth}}session: c.get("session"),{{/if}}
			{{#if database}}db: c.get("db"),{{/if}}
		}),
		{{/if}}
	}),
);
{{/if}}

// Routes
for (const route of routes) {
	app.route("/", route);
}

export default app;
